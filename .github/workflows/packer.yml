name: Packer Build

on:
  push:
    branches:
      - main
    paths:
      - "talos/**"
      - ".github/workflows/packer.yml"
  pull_request:
    branches:
      - main
    paths:
      - "talos/**"
      - ".github/workflows/packer.yml"
  workflow_dispatch:
    inputs:
      talos_version:
        description: "Talos version to build (e.g., v1.6.0)"
        required: false
        type: string
      force_build:
        description: "Force build even on PR"
        required: false
        type: boolean
        default: false

env:
  PACKER_VERSION: "1.10.0"

jobs:
  validate:
    name: Validate Packer Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Initialize Packer
        working-directory: talos
        run: packer init talos_hcloud.pkr.hcl

      - name: Format check
        working-directory: talos
        run: packer fmt -check talos_hcloud.pkr.hcl

      - name: Validate
        working-directory: talos
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: packer validate talos_hcloud.pkr.hcl

  build:
    name: Build Talos Image
    runs-on: ubuntu-latest
    needs: validate
    # Only build on main branch pushes, manual triggers, or when force_build is true
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' && github.event.inputs.force_build == 'true')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Initialize Packer
        working-directory: talos
        run: packer init talos_hcloud.pkr.hcl

      - name: Build image
        working-directory: talos
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          if [ -n "${{ inputs.talos_version }}" ]; then
            packer build -var "talos_version=${{ inputs.talos_version }}" talos_hcloud.pkr.hcl | tee packer-output.log
          else
            packer build talos_hcloud.pkr.hcl | tee packer-output.log
          fi

      - name: Extract snapshot info
        if: success()
        id: snapshot
        working-directory: talos
        run: |
          # Extract snapshot ID from packer output
          SNAPSHOT_ID=$(grep -oP 'Snapshot ID: \K\d+' packer-output.log || echo "N/A")
          SNAPSHOT_NAME=$(grep -oP 'Snapshot name: \K.*' packer-output.log || echo "N/A")

          echo "snapshot_id=$SNAPSHOT_ID" >> $GITHUB_OUTPUT
          echo "snapshot_name=$SNAPSHOT_NAME" >> $GITHUB_OUTPUT

      - name: Build summary
        if: success()
        run: |
          echo "### âœ… Talos Image Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Talos Version | ${{ inputs.talos_version || 'v1.6.0 (default)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Snapshot Name | ${{ steps.snapshot.outputs.snapshot_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Snapshot ID | ${{ steps.snapshot.outputs.snapshot_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The image is now available in your Hetzner Cloud project." >> $GITHUB_STEP_SUMMARY
